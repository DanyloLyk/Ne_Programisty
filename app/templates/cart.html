{% extends 'base.html' %}

{% block title %}–ö–æ—à–∏–∫ - –ì—Ä–∞–ª—å–Ω–∞ –ö–æ–º–æ—Ä–∞{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="fw-bold text-warning mb-4">üõí –í–∞—à –∫–æ—à–∏–∫</h2>
    
    {# –ü–æ—Ä–æ–∂–Ω—ñ–π –∫–æ—à–∏–∫ #}
    <div id="cart-empty" style="display: none;">
        <div class="alert-info">
            <h4 class="alert-heading">–í–∞—à –∫–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</h4>
            <p class="mb-0">–î–æ–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä–∏ –∑ <a href="{{ url_for('main.catalog') }}" class="icon-link">–∫–∞—Ç–∞–ª–æ–≥—É</a>.</p>
        </div>
    </div>

    {# –ö–æ—à–∏–∫ –∑ —Ç–æ–≤–∞—Ä–∞–º–∏ #}
    <div id="cart-items" style="display: none;">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <div id="cart-items-list">
                            {# –¢–æ–≤–∞—Ä–∏ –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ —á–µ—Ä–µ–∑ JavaScript #}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">–ü—ñ–¥—Å—É–º–æ–∫ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h5>
                        <hr>
                        <div class="d-flex justify-content-between mb-2">
                            <span>–¢–æ–≤–∞—Ä—ñ–≤:</span>
                            <strong id="total-items">0</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span>–ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞:</span>
                            <strong class="text-warning" id="total-price">0 ‚Ç¥</strong>
                        </div>
                        <a href="{{ url_for('main.checkout') }}" class="btn btn-warning w-100 fw-bold" id="checkout-btn">
                            –û—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
                        </a>
                        <a href="{{ url_for('main.catalog') }}" class="btn btn-outline-secondary w-100 mt-2">
                            –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –ø–æ–∫—É–ø–∫–∏
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const cartItems = JSON.parse('{{ carts | tojson | safe }}');
    const discountMultiplier = Number({{ discount_multiplier | tojson | safe }} || 1.0);
    const emptyContainer = document.getElementById('cart-empty');
    const itemsContainer = document.getElementById('cart-items');
    const itemsList = document.getElementById('cart-items-list');
    const totalItemsEl = document.getElementById('total-items');
    const totalPriceEl = document.getElementById('total-price');
    const checkoutBtn = document.getElementById('checkout-btn');

    if (cartItems && Array.isArray(cartItems) && cartItems.length > 0) {
        // –ü–æ–∫–∞–∑—É—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑ —Ç–æ–≤–∞—Ä–∞–º–∏
        itemsContainer.style.display = 'block';
        emptyContainer.style.display = 'none';
        
        let totalItems = 0;
        let totalPrice = 0;
        
        // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —Ç–æ–≤–∞—Ä–∏
        cartItems.forEach(cartItem => {
            const item = cartItem.item;
            if (!item) return;
            
            // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –≤ —á–∏—Å–ª–∞, –≤–∏–¥–∞–ª—è—é—á–∏ –ø—Ä–æ–±—ñ–ª–∏ —Ç–∞ –∫–æ–º–∏
            const priceStr = String(item.price).replace(/\s/g, '').replace(',', '.');
            const price = parseFloat(priceStr) || 0;
            const quantity = parseInt(cartItem.quantity) || 0;
            // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –º–Ω–æ–∂–Ω–∏–∫–∞ –∑–Ω–∏–∂–∫–∏
            const itemTotalOriginal = price * quantity;
            const itemTotal = itemTotalOriginal * (parseFloat(discountMultiplier) || 1.0);

            totalItems += quantity;
            totalPrice += itemTotal;
            
            const cartItemHtml = `
                <div class="card mb-3" id="cart-item-${cartItem.id}">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <img src="/static/${item.image}" 
                                     class="img-fluid rounded" 
                                     alt="${item.name}"
                                     style="max-height: 100px; object-fit: cover;">
                            </div>
                            <div class="col-md-6">
                                <h5 class="card-title mb-1">${item.name}</h5>
                                <p class="card-text text-muted small mb-1">${item.description}</p>
                                <p class="text-warning fw-bold mb-0">
                                    ${price.toFixed(2)} ‚Ç¥ √ó ${quantity} = 
                                    ${(discountMultiplier < 1) ? `<del class="text-muted">${itemTotalOriginal.toFixed(2)} ‚Ç¥</del> <span class="ms-2">${itemTotal.toFixed(2)} ‚Ç¥</span>` : `${itemTotal.toFixed(2)} ‚Ç¥`}
                                </p>
                            </div>
                            <div class="col-md-2 text-center">
                                <div class="btn-group" role="group">
                                    <a href="/update_cart/${cartItem.item_id}?action=decrease" 
                                       class="btn btn-outline-secondary btn-sm">-</a>
                                    <span class="btn btn-outline-secondary btn-sm disabled" style="min-width: 50px;">
                                        ${quantity}
                                    </span>
                                    <a href="/update_cart/${cartItem.item_id}?action=increase" 
                                       class="btn btn-outline-secondary btn-sm">+</a>
                                </div>
                            </div>
                            <div class="col-md-2 text-end">
                                <a href="/remove_from_cart/${cartItem.item_id}"
                                   class="btn btn-outline-danger btn-sm"
                                   onclick="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ–≤–∞—Ä –∑ –∫–æ—à–∏–∫–∞?')">
                                    üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            itemsList.innerHTML += cartItemHtml;
        });
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –ø—ñ–¥—Å—É–º–æ–∫
        totalItemsEl.textContent = totalItems;
        totalPriceEl.textContent = totalPrice.toFixed(2) + ' ‚Ç¥';
        
        // –ë–ª–æ–∫—É—î–º–æ –∫–Ω–æ–ø–∫—É, —è–∫—â–æ –∫–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π
        if (totalItems === 0) {
            checkoutBtn.classList.add('disabled');
            checkoutBtn.href = '#';
        }
    } else {
        // –ü–æ–∫–∞–∑—É—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ—Ä–æ–∂–Ω—å–æ–≥–æ –∫–æ—à–∏–∫–∞
        emptyContainer.style.display = 'block';
        itemsContainer.style.display = 'none';
    }
</script>

{% if orders and orders|length > 0 %}
<hr class="my-4">
<div class="container mt-3">
    <h4 class="fw-bold text-warning mb-3">üì¶ –í–∞—à—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h4>
    <div class="list-group">
        {% for order in orders %}
        <div class="list-group-item">
            <div class="d-flex w-100 justify-content-between">
                <h5 class="mb-1">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #{{ order.id }}</h5>
                <small class="text-muted">–°—Ç–∞—Ç—É—Å: {{ order.status }}</small>
            </div>
            <p class="mb-1">–°—É–º–∞: <strong class="text-warning">{{ order.total_amount }} ‚Ç¥</strong></p>
            <ul class="mb-0">
                {% for it in order.order_items %}
                <li>{{ it.name }} ‚Äî x{{ it.quantity }} ‚Äî {{ '%.2f'|format(it.price) }} ‚Ç¥</li>
                {% endfor %}
            </ul>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}