{% extends 'base.html' %}
{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">
            <div class="feedback-form-card dark-theme shadow-lg p-4 p-md-5">
                <h2 class="text-center mb-4">Відновлення пароля</h2>
                <p class="text-center mb-4">Введіть новий пароль для вашого облікового запису</p>

                <form id="reset-password-page-form">
                    <input type="hidden" id="reset-token" value="{{ token }}">

                    <div class="form-group mb-4">
                        <label for="reset-password" class="form-label">Новий пароль</label>
                        <input type="password" name="password" id="reset-password" class="form-control" placeholder="Введіть новий пароль" required>
                    </div>

                    <div class="form-group mb-4">
                        <label for="reset-confirm" class="form-label">Підтвердіть пароль</label>
                        <input type="password" name="confirm" id="reset-confirm" class="form-control" placeholder="Повторіть новий пароль" required>
                    </div>

                    <div class="d-grid gap-2 mb-3">
                        <button class="btn btn-outline-warning btn-lg" type="submit" id="reset-btn">
                            Змінити пароль
                        </button>
                    </div>

                    <div id="reset-message" class="text-center"></div>
                </form>

                <div class="text-center mt-3">
                    <a href="{{ url_for('main.index') }}">Повернутися на головну</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById("reset-password-page-form");
    const messageDiv = document.getElementById("reset-message");
    const resetBtn = document.getElementById("reset-btn");

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const token = document.getElementById("reset-token").value;
        const password = document.getElementById("reset-password").value.trim();
        const confirm = document.getElementById("reset-confirm").value.trim();

        if (!password || !confirm) {
            messageDiv.innerHTML = '<div class="alert alert-warning">Заповніть всі поля</div>';
            return;
        }

        if (password !== confirm) {
            messageDiv.innerHTML = '<div class="alert alert-danger">Паролі не співпадають</div>';
            return;
        }

        resetBtn.disabled = true;
        resetBtn.textContent = 'Змінюємо...';

        try {
            const response = await fetch("/api/v1/auth/reset-password", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    token: token,
                    new_password: password,
                    confirm_password: confirm,
                }),
            });

            const data = await response.json();

            if (response.ok) {
                messageDiv.innerHTML = '<div class="alert alert-success">Пароль успішно змінено! Через 3 секунди ви будете перенаправлені на сторінку входу.</div>';
                setTimeout(() => {
                    window.location.href = "{{ url_for('main.index') }}";
                }, 3000);
            } else {
                messageDiv.innerHTML = `<div class="alert alert-danger">${data.message || "Помилка при зміні пароля"}</div>`;
            }
        } catch (error) {
            console.error("Помилка:", error);
            messageDiv.innerHTML = '<div class="alert alert-danger">Помилка мережі. Спробуйте пізніше.</div>';
        } finally {
            resetBtn.disabled = false;
            resetBtn.textContent = 'Змінити пароль';
        }
    });
});
</script>
{% endblock %}